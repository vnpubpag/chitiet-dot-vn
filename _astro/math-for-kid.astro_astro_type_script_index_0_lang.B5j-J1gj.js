function ht(){let n={op:"add",digits:1,fixedPos:"none",fixedVal:0,count:5,mode:"practice",perQSec:10,totalMin:3},c=[],i=0,_=null,b=null,p=0,m=0,d=!1;const B=document.getElementById("mfk-prepare"),h=document.getElementById("mfk-practice"),Q=document.getElementById("mfk-ops"),P=document.getElementById("mfk-digits"),N=document.getElementById("mfk-fixed-pos"),w=document.getElementById("mfk-fixed-val"),V=document.getElementById("mfk-counts"),k=document.getElementById("mfk-custom-count"),H=document.getElementById("mfk-mode-switch"),U=document.getElementById("mfk-timer-settings"),O=document.getElementById("mfk-per-q"),D=document.getElementById("mfk-total-time"),Z=document.getElementById("mfk-total-time-val"),G=document.getElementById("mfk-auto-count-note"),tt=document.getElementById("mfk-start"),x=document.getElementById("mfk-timer-bar"),K=document.getElementById("mfk-clock"),W=document.getElementById("mfk-per-q-clock"),et=document.getElementById("mfk-progress-bar"),nt=document.getElementById("mfk-progress-text"),C=document.getElementById("mfk-question-area"),st=document.getElementById("mfk-q-index"),ot=document.getElementById("mfk-q-a"),ct=document.getElementById("mfk-q-op"),at=document.getElementById("mfk-q-b"),u=document.getElementById("mfk-q-answer"),v=document.getElementById("mfk-feedback"),lt=document.getElementById("mfk-skip"),rt=document.getElementById("mfk-submit"),g=document.getElementById("mfk-grid"),$=document.getElementById("mfk-grid-actions"),it=document.getElementById("mfk-grade"),X=document.getElementById("mfk-results"),dt=document.getElementById("mfk-results-stats"),Y=document.getElementById("mfk-results-list"),j=document.getElementById("mfk-quit-wrap"),mt=document.getElementById("mfk-quit"),ut=document.getElementById("mfk-retry"),ft=document.getElementById("mfk-back-config");function z(t,e){return Math.floor(Math.random()*(e-t+1))+t}function F(t){const e=Math.floor(t/60),s=t%60;return String(e).padStart(2,"0")+":"+String(s).padStart(2,"0")}const pt={add:"+",sub:"−",mul:"×",div:"÷"};function y(t,e,s){t.querySelectorAll("button").forEach(o=>o.classList.remove(s)),e.classList.add(s)}Q.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.op=e.dataset.op,y(Q,e,"mfk-op--active"))}),P.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.digits=parseInt(e.dataset.digits),y(P,e,"mfk-toggle__btn--active"))}),N.addEventListener("change",()=>{n.fixedPos=N.value,w.style.display=n.fixedPos==="none"?"none":""}),w.addEventListener("input",()=>{n.fixedVal=parseInt(w.value)||0}),V.addEventListener("click",t=>{const e=t.target.closest("button");if(!e)return;const s=e.dataset.count;y(V,e,"mfk-count--active"),s==="custom"?(k.style.display="",k.focus()):(k.style.display="none",n.count=parseInt(s))}),k.addEventListener("input",()=>{const t=parseInt(k.value);t>0&&t<=100&&(n.count=t)}),H.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.mode=e.dataset.mode,y(H,e,"mfk-mode-switch__btn--active"),U.style.display=n.mode==="timed"?"":"none",S())}),O.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.perQSec=parseInt(e.dataset.sec),y(O,e,"mfk-count--active"),S())}),D.addEventListener("input",()=>{n.totalMin=parseInt(D.value),Z.textContent=n.totalMin+" phút",S()});function S(){if(n.mode==="timed"){const t=Math.floor(n.totalMin*60/n.perQSec);n.count=t,G.textContent=`Tự động: ${t} câu hỏi (${n.totalMin} phút ÷ ${n.perQSec}s/câu)`}else G.textContent=""}function kt(){c=[];const t=n.digits===1?9:99,e=n.digits===1?1:10;for(let s=0;s<n.count;s++){let o,a,r,f=0;do{switch(o=n.fixedPos==="first"?n.fixedVal:z(e,t),a=n.fixedPos==="second"?n.fixedVal:z(e,t),n.op){case"sub":o<a&&([o,a]=[a,o]),r=o-a;break;case"mul":r=o*a;break;case"div":r=o,o=o*a;break;default:r=o+a}f++}while(f<50&&gt(o,a));c.push({a:o,b:a,op:n.op,opSymbol:pt[n.op],answer:r,userAnswer:null})}}function gt(t,e){return c.some(s=>s.a===t&&s.b===e)}tt.addEventListener("click",J);function J(){kt(),i=0,d=!1,B.style.display="none",h.style.display="",X.style.display="none",j.style.display="",n.mode==="timed"?(x.style.display="",C.style.display="",g.style.display="none",$.style.display="none",p=n.totalMin*60,m=n.perQSec,yt(),vt(),E(0)):(x.style.display="none",C.style.display="none",g.style.display="",$.style.display="",$t())}function E(t){if(t>=c.length||d){q();return}i=t;const e=c[t];st.textContent=`Câu ${t+1} / ${c.length}`,ot.textContent=String(e.a),ct.textContent=e.opSymbol,at.textContent=String(e.b),u.value="",v.textContent="",v.className="mfk-question__feedback",u.className="mfk-question__input",u.focus(),L(t),m=n.perQSec}function L(t){const e=c.length>0?t/c.length*100:0;et.style.width=e+"%",nt.textContent=`${t} / ${c.length}`}rt.addEventListener("click",R),u.addEventListener("keydown",t=>{t.key==="Enter"&&R()});function R(){if(d)return;const t=c[i],e=u.value.trim();if(e==="")return;t.userAnswer=parseInt(e);const s=t.userAnswer===t.answer;v.textContent=s?"Đúng rồi!":`Sai! Đáp án: ${t.answer}`,v.className="mfk-question__feedback "+(s?"mfk-feedback--correct":"mfk-feedback--wrong"),u.className="mfk-question__input "+(s?"mfk-input--correct":"mfk-input--wrong"),setTimeout(()=>{E(i+1)},800)}lt.addEventListener("click",()=>{d||(c[i].userAnswer=null,E(i+1))});function yt(){clearInterval(_),K.textContent=F(p),_=setInterval(()=>{p--,K.textContent=F(p),p<=0&&q()},1e3)}function vt(){clearInterval(b),W.textContent=String(m),b=setInterval(()=>{m--,W.textContent=String(Math.max(0,m)),m<=0&&(c[i].userAnswer=null,E(i+1))},1e3)}function A(){clearInterval(_),clearInterval(b)}function $t(){g.innerHTML="";const t=["#2563eb","#9333ea","#d97706","#059669"];c.forEach((e,s)=>{const o=document.createElement("div");o.className="mfk-card";const a=t[s%t.length];o.innerHTML=`
                <div class="mfk-card__expr" style="color:${a}">
                    ${e.a} ${e.opSymbol} ${e.b}
                </div>
                <div class="mfk-card__answer">
                    <label class="mfk-card__label">Kết quả:</label>
                    <input class="mfk-card__input" type="number" placeholder="?" data-idx="${s}" inputmode="numeric" autocomplete="off" />
                </div>
            `,g.appendChild(o)}),L(0)}it.addEventListener("click",()=>{g.querySelectorAll(".mfk-card__input").forEach(e=>{const s=parseInt(e.dataset.idx),o=c[s],a=e.value.trim();o.userAnswer=a!==""?parseInt(a):null;const r=e.closest(".mfk-card");r.classList.remove("mfk-card--correct","mfk-card--wrong"),o.userAnswer===o.answer?r.classList.add("mfk-card--correct"):r.classList.add("mfk-card--wrong"),e.disabled=!0}),$.style.display="none",q()});function q(){d=!0,A(),C.style.display="none",x.style.display="none",$.style.display="none",j.style.display="none",X.style.display="";const t=c.length,e=c.filter(l=>l.userAnswer!==null).length,s=c.filter(l=>l.userAnswer===l.answer).length,o=e-s,a=t-e,r=s*100;L(t);const f=document.getElementById("mfk-results-subtitle");s===t?f.textContent="Xuất sắc! Bé đã trả lời đúng tất cả!":s>=t*.7?f.textContent="Chúc mừng bé đã hoàn thành bài tập rất tốt!":f.textContent="Cố gắng luyện tập thêm nhé, bé sẽ giỏi hơn!",document.getElementById("mfk-score-num").textContent=String(r),document.getElementById("mfk-score-badge-text").textContent=`${s}/${t} Câu đúng`,dt.innerHTML=`
            <div class="mfk-stat mfk-stat--correct">
                <span class="mfk-stat__val">${s}</span>
                <span class="mfk-stat__label">Đúng</span>
            </div>
            <div class="mfk-stat mfk-stat--wrong">
                <span class="mfk-stat__val">${o}</span>
                <span class="mfk-stat__label">Sai</span>
            </div>
            <div class="mfk-stat mfk-stat--skip">
                <span class="mfk-stat__val">${a}</span>
                <span class="mfk-stat__label">Bỏ qua</span>
            </div>
        `,Y.innerHTML="",c.forEach((l,Et)=>{const M=l.userAnswer===l.answer,I=l.userAnswer===null,It=I?"mfk-result--skipped":M?"mfk-result--correct":"mfk-result--wrong",T=document.createElement("div");T.className=`mfk-result ${It}`;const _t=I?"—":String(l.userAnswer),bt=I?"mfk-result__user--skip":M?"mfk-result__user--correct":"mfk-result__user--wrong",Bt=I?"⛔":M?"✅":"❌";T.innerHTML=`
                <div class="mfk-result__left">
                    <span class="mfk-result__idx">Câu ${Et+1}</span>
                    <p class="mfk-result__expr">${l.a} ${l.opSymbol} ${l.b} = <span class="mfk-result__answer">${l.answer}</span></p>
                </div>
                <div class="mfk-result__right">
                    <div class="mfk-result__user-wrap">
                        <span class="mfk-result__user-label">Bé chọn</span>
                        <span class="mfk-result__user ${bt}">${_t}</span>
                    </div>
                    <span class="mfk-result__icon">${Bt}</span>
                </div>
            `,Y.appendChild(T)})}ut.addEventListener("click",()=>{J()}),ft.addEventListener("click",()=>{A(),d=!1,h.style.display="none",B.style.display=""}),mt.addEventListener("click",()=>{A(),d=!1,h.style.display="none",B.style.display=""})}ht();
