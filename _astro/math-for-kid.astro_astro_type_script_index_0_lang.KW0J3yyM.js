let n={op:"add",digits:1,fixedPos:"none",fixedVal:0,count:5,mode:"practice",perQSec:10,totalMin:3},c=[],i=0,B=null,h=null,p=0,u=0,d=!1;const S=document.getElementById("mfk-prepare"),L=document.getElementById("mfk-practice"),Q=document.getElementById("mfk-ops"),P=document.getElementById("mfk-digits"),N=document.getElementById("mfk-fixed-pos"),w=document.getElementById("mfk-fixed-val"),V=document.getElementById("mfk-counts"),k=document.getElementById("mfk-custom-count"),H=document.getElementById("mfk-mode-switch"),st=document.getElementById("mfk-timer-settings"),O=document.getElementById("mfk-per-q"),D=document.getElementById("mfk-total-time"),ot=document.getElementById("mfk-total-time-val"),G=document.getElementById("mfk-auto-count-note"),ct=document.getElementById("mfk-start"),x=document.getElementById("mfk-timer-bar"),K=document.getElementById("mfk-clock"),W=document.getElementById("mfk-per-q-clock"),at=document.getElementById("mfk-progress-bar"),lt=document.getElementById("mfk-progress-text"),C=document.getElementById("mfk-question-area"),rt=document.getElementById("mfk-q-index"),it=document.getElementById("mfk-q-a"),dt=document.getElementById("mfk-q-op"),mt=document.getElementById("mfk-q-b"),f=document.getElementById("mfk-q-answer"),$=document.getElementById("mfk-feedback"),ut=document.getElementById("mfk-skip"),ft=document.getElementById("mfk-submit"),g=document.getElementById("mfk-grid"),E=document.getElementById("mfk-grid-actions"),pt=document.getElementById("mfk-grade"),z=document.getElementById("mfk-results"),kt=document.getElementById("mfk-results-stats"),X=document.getElementById("mfk-results-list"),F=document.getElementById("mfk-quit-wrap"),gt=document.getElementById("mfk-quit"),yt=document.getElementById("mfk-retry"),vt=document.getElementById("mfk-back-config");function Y(t,e){return Math.floor(Math.random()*(e-t+1))+t}function j(t){const e=Math.floor(t/60),s=t%60;return String(e).padStart(2,"0")+":"+String(s).padStart(2,"0")}const $t={add:"+",sub:"−",mul:"×",div:"÷"};function y(t,e,s){t.querySelectorAll("button").forEach(o=>o.classList.remove(s)),e.classList.add(s)}Q.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.op=e.dataset.op,y(Q,e,"mfk-op--active"))});P.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.digits=parseInt(e.dataset.digits),y(P,e,"mfk-toggle__btn--active"))});N.addEventListener("change",()=>{n.fixedPos=N.value,w.style.display=n.fixedPos==="none"?"none":""});w.addEventListener("input",()=>{n.fixedVal=parseInt(w.value)||0});V.addEventListener("click",t=>{const e=t.target.closest("button");if(!e)return;const s=e.dataset.count;y(V,e,"mfk-count--active"),s==="custom"?(k.style.display="",k.focus()):(k.style.display="none",n.count=parseInt(s))});k.addEventListener("input",()=>{const t=parseInt(k.value);t>0&&t<=100&&(n.count=t)});H.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.mode=e.dataset.mode,y(H,e,"mfk-mode-switch__btn--active"),st.style.display=n.mode==="timed"?"":"none",A())});O.addEventListener("click",t=>{const e=t.target.closest("button");e&&(n.perQSec=parseInt(e.dataset.sec),y(O,e,"mfk-count--active"),A())});D.addEventListener("input",()=>{n.totalMin=parseInt(D.value),ot.textContent=n.totalMin+" phút",A()});function A(){if(n.mode==="timed"){const t=Math.floor(n.totalMin*60/n.perQSec);n.count=t,G.textContent=`Tự động: ${t} câu hỏi (${n.totalMin} phút ÷ ${n.perQSec}s/câu)`}else G.textContent=""}function Et(){c=[];const t=n.digits===1?9:99,e=n.digits===1?1:10;for(let s=0;s<n.count;s++){let o,a,r,m=0;do{switch(o=n.fixedPos==="first"?n.fixedVal:Y(e,t),a=n.fixedPos==="second"?n.fixedVal:Y(e,t),n.op){case"sub":o<a&&([o,a]=[a,o]),r=o-a;break;case"mul":r=o*a;break;case"div":r=o,o=o*a;break;default:r=o+a}m++}while(m<50&&It(o,a));c.push({a:o,b:a,op:n.op,opSymbol:$t[n.op],answer:r,userAnswer:null})}}function It(t,e){return c.some(s=>s.a===t&&s.b===e)}ct.addEventListener("click",J);function J(){Et(),i=0,d=!1,S.style.display="none",L.style.display="",z.style.display="none",F.style.display="",n.mode==="timed"?(x.style.display="",C.style.display="",g.style.display="none",E.style.display="none",p=n.totalMin*60,u=n.perQSec,_t(),bt(),I(0)):(x.style.display="none",C.style.display="none",g.style.display="",E.style.display="",Bt())}function I(t){if(t>=c.length||d){T();return}i=t;const e=c[t];rt.textContent=`Câu ${t+1} / ${c.length}`,it.textContent=String(e.a),dt.textContent=e.opSymbol,mt.textContent=String(e.b),f.value="",$.textContent="",$.className="mfk-question__feedback",f.className="mfk-question__input",f.focus(),q(t),u=n.perQSec}function q(t){const e=c.length>0?t/c.length*100:0;at.style.width=e+"%",lt.textContent=`${t} / ${c.length}`}ft.addEventListener("click",R);f.addEventListener("keydown",t=>{t.key==="Enter"&&R()});function R(){if(d)return;const t=c[i],e=f.value.trim();if(e==="")return;t.userAnswer=parseInt(e);const s=t.userAnswer===t.answer;$.textContent=s?"Đúng rồi!":`Sai! Đáp án: ${t.answer}`,$.className="mfk-question__feedback "+(s?"mfk-feedback--correct":"mfk-feedback--wrong"),f.className="mfk-question__input "+(s?"mfk-input--correct":"mfk-input--wrong"),setTimeout(()=>{I(i+1)},800)}ut.addEventListener("click",()=>{d||(c[i].userAnswer=null,I(i+1))});function _t(){clearInterval(B),K.textContent=j(p),B=setInterval(()=>{p--,K.textContent=j(p),p<=0&&T()},1e3)}function bt(){clearInterval(h),W.textContent=String(u),h=setInterval(()=>{u--,W.textContent=String(Math.max(0,u)),u<=0&&(c[i].userAnswer=null,I(i+1))},1e3)}function M(){clearInterval(B),clearInterval(h)}function Bt(){g.innerHTML="";const t=["#2563eb","#9333ea","#d97706","#059669"];c.forEach((e,s)=>{const o=document.createElement("div");o.className="mfk-card";const a=t[s%t.length];o.innerHTML=`
                <div class="mfk-card__expr" style="color:${a}">
                    ${e.a} ${e.opSymbol} ${e.b}
                </div>
                <div class="mfk-card__answer">
                    <label class="mfk-card__label">Kết quả:</label>
                    <input class="mfk-card__input" type="number" placeholder="?" data-idx="${s}" inputmode="numeric" autocomplete="off" />
                </div>
            `,g.appendChild(o)}),q(0)}pt.addEventListener("click",()=>{g.querySelectorAll(".mfk-card__input").forEach(e=>{const s=parseInt(e.dataset.idx),o=c[s],a=e.value.trim();o.userAnswer=a!==""?parseInt(a):null;const r=e.closest(".mfk-card");r.classList.remove("mfk-card--correct","mfk-card--wrong"),o.userAnswer===o.answer?r.classList.add("mfk-card--correct"):r.classList.add("mfk-card--wrong"),e.disabled=!0}),E.style.display="none",T()});function T(){d=!0,M(),C.style.display="none",x.style.display="none",E.style.display="none",F.style.display="none",z.style.display="";const t=c.length,e=c.filter(l=>l.userAnswer!==null).length,s=c.filter(l=>l.userAnswer===l.answer).length,o=e-s,a=t-e,r=s*100;q(t);const m=document.getElementById("mfk-results-subtitle");s===t?m.textContent="Xuất sắc! Bé đã trả lời đúng tất cả!":s>=t*.7?m.textContent="Chúc mừng bé đã hoàn thành bài tập rất tốt!":m.textContent="Cố gắng luyện tập thêm nhé, bé sẽ giỏi hơn!",document.getElementById("mfk-score-num").textContent=String(r),document.getElementById("mfk-score-badge-text").textContent=`${s}/${t} Câu đúng`,kt.innerHTML=`
            <div class="mfk-stat mfk-stat--correct">
                <span class="mfk-stat__val">${s}</span>
                <span class="mfk-stat__label">Đúng</span>
            </div>
            <div class="mfk-stat mfk-stat--wrong">
                <span class="mfk-stat__val">${o}</span>
                <span class="mfk-stat__label">Sai</span>
            </div>
            <div class="mfk-stat mfk-stat--skip">
                <span class="mfk-stat__val">${a}</span>
                <span class="mfk-stat__label">Bỏ qua</span>
            </div>
        `,X.innerHTML="",c.forEach((l,U)=>{const _=l.userAnswer===l.answer,v=l.userAnswer===null,Z=v?"mfk-result--skipped":_?"mfk-result--correct":"mfk-result--wrong",b=document.createElement("div");b.className=`mfk-result ${Z}`;const tt=v?"—":String(l.userAnswer),et=v?"mfk-result__user--skip":_?"mfk-result__user--correct":"mfk-result__user--wrong",nt=v?"⛔":_?"✅":"❌";b.innerHTML=`
                <div class="mfk-result__left">
                    <span class="mfk-result__idx">Câu ${U+1}</span>
                    <p class="mfk-result__expr">${l.a} ${l.opSymbol} ${l.b} = <span class="mfk-result__answer">${l.answer}</span></p>
                </div>
                <div class="mfk-result__right">
                    <div class="mfk-result__user-wrap">
                        <span class="mfk-result__user-label">Bé chọn</span>
                        <span class="mfk-result__user ${et}">${tt}</span>
                    </div>
                    <span class="mfk-result__icon">${nt}</span>
                </div>
            `,X.appendChild(b)})}yt.addEventListener("click",()=>{J()});vt.addEventListener("click",()=>{M(),d=!1,L.style.display="none",S.style.display=""});gt.addEventListener("click",()=>{M(),d=!1,L.style.display="none",S.style.display=""});
